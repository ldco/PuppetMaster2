# ============================================
# Security - Firewall and SSH hardening
# ============================================

- name: Install security packages
  apt:
    name:
      - ufw
      - fail2ban
      - unattended-upgrades
    state: present
  tags: [security, packages]

- name: Enable automatic security updates
  copy:
    dest: /etc/apt/apt.conf.d/20auto-upgrades
    content: |
      APT::Periodic::Update-Package-Lists "1";
      APT::Periodic::Unattended-Upgrade "1";
      APT::Periodic::AutocleanInterval "7";
  tags: [security, updates]

- name: Configure fail2ban for SSH
  copy:
    dest: /etc/fail2ban/jail.local
    content: |
      [sshd]
      enabled = true
      port = ssh
      filter = sshd
      logpath = /var/log/auth.log
      maxretry = 5
      bantime = 3600
      findtime = 600
  notify: Restart fail2ban
  tags: [security, fail2ban]

- name: Enable fail2ban
  systemd:
    name: fail2ban
    state: started
    enabled: yes
  tags: [security, fail2ban]

- name: Set UFW default policies
  ufw:
    direction: '{{ item.direction }}'
    policy: '{{ item.policy }}'
  loop:
    - { direction: incoming, policy: deny }
    - { direction: outgoing, policy: allow }
  tags: [security, firewall]

- name: Allow SSH
  ufw:
    rule: allow
    port: '22'
    proto: tcp
  tags: [security, firewall]

- name: Allow HTTP
  ufw:
    rule: allow
    port: '80'
    proto: tcp
  tags: [security, firewall]

- name: Allow HTTPS
  ufw:
    rule: allow
    port: '443'
    proto: tcp
  tags: [security, firewall]

- name: Enable UFW
  ufw:
    state: enabled
  tags: [security, firewall]

- name: Disable root password login
  lineinfile:
    path: /etc/ssh/sshd_config
    regexp: '^#?PermitRootLogin'
    line: 'PermitRootLogin prohibit-password'
  notify: Restart SSH
  tags: [security, ssh]

- name: Disable password authentication
  lineinfile:
    path: /etc/ssh/sshd_config
    regexp: '^#?PasswordAuthentication'
    line: 'PasswordAuthentication no'
  notify: Restart SSH
  tags: [security, ssh]

- name: Limit SSH connection attempts
  lineinfile:
    path: /etc/ssh/sshd_config
    regexp: '^#?MaxStartups'
    line: 'MaxStartups 10:30:60'
  notify: Restart SSH
  tags: [security, ssh]

- name: Set SSH idle timeout
  lineinfile:
    path: /etc/ssh/sshd_config
    regexp: '^#?ClientAliveInterval'
    line: 'ClientAliveInterval 300'
  notify: Restart SSH
  tags: [security, ssh]

- name: Enable verbose SSH logging for audit
  lineinfile:
    path: /etc/ssh/sshd_config
    regexp: '^#?LogLevel'
    line: 'LogLevel VERBOSE'
  notify: Restart SSH
  tags: [security, ssh, audit]
